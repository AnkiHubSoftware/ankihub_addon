name: Create Release

on:
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GH_BOT_ACCESS_TOKEN }}

      - name: Setup git config
        run: |
          git config user.name "ankihub-addon-bot"
          git config user.email "gh@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.8

      - name: Create ankiaddon file
        run: |
          bash ./scripts/release.sh
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      - name: Declare version variable
        id: vars
        run: |
          echo "::set-output name=version::$(scripts/calver.sh)"

      - name: Commit version bump and create tag
        run: |
          git commit --allow-empty -m "Bump Version to ${{ steps.vars.outputs.version }}"
          git push origin main
          git tag ${{ steps.vars.outputs.version }}
          git push origin ${{ steps.vars.outputs.version }}

      - name: Create github release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.vars.outputs.version }}
          files: ankihub.ankiaddon

  upload-to-ankiweb:
    needs: create-release
    uses: ./.github/workflows/upload_to_ankiweb.yml

  upload_to-s3:
    needs: create-release
    uses: ./.github/workflows/upload_to_s3.yml
